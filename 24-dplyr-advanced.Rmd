# Advanced dplyr Patterns {#dplyr-advanced}

<div class="chapter-summary">
**What You'll Learn:**

- Programming with dplyr
- Tidy evaluation
- Dynamic column selection
- Row-wise operations
- Complex aggregations

**Key Errors Covered:** 12+ advanced dplyr errors

**Difficulty:** ‚≠ê‚≠ê‚≠ê Advanced
</div>

## Introduction

Advanced dplyr enables programmatic data manipulation:

```{r message=FALSE}
library(dplyr)
library(rlang)

# Function with column name as string
summarize_col <- function(data, col_name) {
  data %>%
    summarize(
      mean = mean(.data[[col_name]], na.rm = TRUE),
      sd = sd(.data[[col_name]], na.rm = TRUE)
    )
}

summarize_col(mtcars, "mpg")
```

Let's master advanced patterns!

## Tidy Evaluation Basics

<div class="insight-box">
üí° **Key Insight: .data and .env Pronouns**

```{r}
# .data pronoun for data frame columns
mtcars %>%
  summarize(avg = mean(.data$mpg))

# .env pronoun for environment variables
threshold <- 20
mtcars %>%
  filter(.data$mpg > .env$threshold)

# In functions
filter_by_value <- function(data, col, value) {
  data %>%
    filter(.data[[col]] > value)
}

filter_by_value(mtcars, "mpg", 20)

# Dynamic column creation
create_column <- function(data, new_col, value) {
  data %>%
    mutate("{new_col}" := value)
}

create_column(mtcars, "test", 42) %>%
  select(mpg, test)
```
</div>

## Error #1: Cannot use object of type 'symbol' {#symbol-error}

<span class="difficulty-advanced">‚≠ê‚≠ê‚≠ê ADVANCED</span> <span class="category-badge cat-tidy-eval">üîÆ TIDY-EVAL</span>

### The Error

```{r error=TRUE}
my_function <- function(data, col) {
  data %>%
    summarize(mean = mean(col))
}

my_function(mtcars, mpg)
```

<div class="error-box">
üî¥ **ERROR**

```
Error in mean(col) : object 'mpg' not found
```
</div>

### What It Means

Need to use tidy evaluation to pass column names.

### Solutions

<div class="solution-box">
‚úÖ **SOLUTION 1: Use {{ }} (Embrace)**

```{r}
my_function <- function(data, col) {
  data %>%
    summarize(mean = mean({{ col }}))
}

my_function(mtcars, mpg)

# Works with multiple operations
my_filter_summarize <- function(data, filter_col, summary_col) {
  data %>%
    filter({{ filter_col }} > 4) %>%
    summarize(
      mean = mean({{ summary_col }}),
      n = n()
    )
}

my_filter_summarize(mtcars, cyl, mpg)
```
</div>

<div class="solution-box">
‚úÖ **SOLUTION 2: Use .data[[]] for Strings**

```{r}
my_function2 <- function(data, col_name) {
  data %>%
    summarize(mean = mean(.data[[col_name]]))
}

my_function2(mtcars, "mpg")

# Dynamic column names
summarize_multiple <- function(data, cols) {
  data %>%
    summarize(
      across(all_of(cols), mean, .names = "mean_{.col}")
    )
}

summarize_multiple(mtcars, c("mpg", "hp", "wt"))
```
</div>

## rowwise() Operations

<div class="insight-box">
üí° **Key Insight: Row-wise Operations**

```{r}
# Calculate row means
data <- tibble(
  id = 1:3,
  x = c(1, 2, 3),
  y = c(4, 5, 6),
  z = c(7, 8, 9)
)

# Wrong: column mean
data %>%
  mutate(mean = mean(c(x, y, z)))

# Right: use rowwise()
data %>%
  rowwise() %>%
  mutate(mean = mean(c(x, y, z))) %>%
  ungroup()

# Or use c_across()
data %>%
  rowwise() %>%
  mutate(mean = mean(c_across(x:z))) %>%
  ungroup()

# Complex row operations
data %>%
  rowwise() %>%
  mutate(
    total = sum(c_across(x:z)),
    min_val = min(c_across(x:z)),
    max_val = max(c_across(x:z))
  ) %>%
  ungroup()
```
</div>

## across() Advanced Usage

<div class="bestpractice-box">
üéØ **Best Practice: across() Patterns**

```{r}
# Multiple functions
mtcars %>%
  summarize(
    across(c(mpg, hp, wt),
           list(mean = mean, sd = sd, min = min, max = max),
           .names = "{.col}_{.fn}")
  )

# With where()
mtcars %>%
  summarize(
    across(where(is.numeric) & !c(vs, am), 
           mean,
           .names = "avg_{.col}")
  )

# In mutate with formula
mtcars %>%
  mutate(
    across(c(mpg, hp), 
           ~ . / mean(.),
           .names = "{.col}_scaled")
  ) %>%
  select(mpg, mpg_scaled, hp, hp_scaled)

# Conditional transformation
mtcars %>%
  mutate(
    across(where(is.numeric), 
           ~ if_else(. < median(.), "Low", "High"),
           .names = "{.col}_cat")
  ) %>%
  select(mpg, mpg_cat, hp, hp_cat)
```
</div>

## if_any() and if_all()

<div class="insight-box">
üí° **Key Insight: Filter with Multiple Conditions**

```{r}
# if_any: TRUE if ANY condition met
mtcars %>%
  filter(if_any(c(mpg, hp), ~ . > 100)) %>%
  select(mpg, hp) %>%
  head()

# if_all: TRUE if ALL conditions met
mtcars %>%
  filter(if_all(c(mpg, hp), ~ . > 100)) %>%
  select(mpg, hp)

# With where()
mtcars %>%
  filter(if_any(where(is.numeric), ~ . > 200)) %>%
  select(where(function(x) any(x > 200)))
```
</div>

## Summary

<div class="chapter-summary">
**Key Takeaways:**

1. **Use {{ }}** - For passing column names to functions
2. **Use .data[[]]** - For string column names
3. **rowwise()** - For row-by-row operations
4. **across()** - Apply functions to multiple columns
5. **if_any() / if_all()** - Filter with multiple conditions
6. **Always ungroup()** - After rowwise()

**Quick Reference:**

```{r eval=FALSE}
# Tidy evaluation
function(data, col) {
  data %>% mutate(new = {{ col }} * 2)
}

# String column names
function(data, col_name) {
  data %>% mutate(new = .data[[col_name]] * 2)
}

# Rowwise
data %>%
  rowwise() %>%
  mutate(mean = mean(c_across(x:z))) %>%
  ungroup()

# across
data %>%
  summarize(across(where(is.numeric), mean))

# if_any/if_all
data %>%
  filter(if_any(c(x, y), ~ . > 10))
```
</div>

## Exercises

<div class="exercise-box">
üìù **Exercise: Create Flexible Function**

Write `summarize_by_group(data, group_col, summary_cols)` using tidy evaluation that groups by one column and summarizes multiple columns.
</div>

## Exercise Answer

<details>
<summary>Click to see answer</summary>

```{r}
summarize_by_group <- function(data, group_col, summary_cols) {
  data %>%
    group_by({{ group_col }}) %>%
    summarize(
      across({{ summary_cols }},
             list(mean = mean, sd = sd, n = ~n()),
             .names = "{.col}_{.fn}"),
      .groups = "drop"
    )
}

summarize_by_group(mtcars, cyl, c(mpg, hp, wt))
```
</details>
